```{r}
# Скрипт для установки всех необходимых пакетов

required_packages <- c(
  "tidyverse",    # Для обработки и визуализации данных
  "ggplot2",      # Для создания графиков (входит в tidyverse, но указан отдельно для ясности)
  "car",          # Для теста на мультиколлинеарность (vif) и других диагностик
  "nortest",      # Для теста Anderson-Darling на нормальность
  "ggpubr",       # Для оформления графиков и добавления p-значений
  "rstatix",      # Для непараметрических тестов и пост-хок анализа
  "broom",        # Для обработки результатов статистических тестов
  "caret",        # Для анализа моделей машинного обучения
  "pROC",         # Для построения ROC-кривых
  "MASS"          # Для дополнительных статистических функций
)

# Функция для проверки и установки пакетов
install_if_needed <- function(packages) {
  for (pkg in packages) {
    if (!requireNamespace(pkg, quietly = TRUE)) {
      install.packages(pkg, dependencies = TRUE)
      message(paste("Пакет", pkg, "установлен"))
    } else {
      message(paste("Пакет", pkg, "уже установлен"))
    }
  }
}

# Установка всех необходимых пакетов
install_if_needed(required_packages)

# Проверка успешной установки и загрузки
message("\nПроверка загрузки пакетов:")
for (pkg in required_packages) {
  if (requireNamespace(pkg, quietly = TRUE)) {
    message(paste("Пакет", pkg, "успешно загружен"))
  } else {
    warning(paste("Не удалось загрузить пакет", pkg))
  }
}

message("\nВсе необходимые пакеты установлены и проверены!")
```

```{r}

```

```{r}
# Загрузка библиотек
library(tidyverse)
library(ggplot2)

# Загрузка данных
df <- read.csv("kidney_disease_dataset.csv", stringsAsFactors = FALSE)

# Очистка и преобразование количественной переменной: eGFR
df$eGFR <- as.numeric(gsub("[^0-9.]", "", df$Estimated.Glomerular.Filtration.Rate..eGFR.))

# Описание eGFR
summary(df$eGFR)
sd(df$eGFR, na.rm = TRUE)

# Тест Шапиро-Уилка на нормальность (на подвыборке из 5000 наблюдений)
set.seed(123)
shapiro.test(sample(na.omit(df$eGFR), 5000))

# Построение гистограммы и Q-Q plot
hist(df$eGFR, breaks = 50, col = "lightblue", main = "Гистограмма eGFR", xlab = "eGFR")
qqnorm(df$eGFR, main = "Q-Q Plot eGFR")
qqline(df$eGFR, col = "red")

# Создание качественной переменной с ≥3 уровнями: возрастные группы
df$Age_group <- cut(df$Age.of.the.patient, 
                    breaks = c(0, 24, 49, 74, Inf),
                    labels = c("0-24", "25-49", "50-74", "75+"))

# Описательная статистика eGFR по возрастным группам
df %>%
  group_by(Age_group) %>%
  summarise(
    Mean = mean(eGFR, na.rm = TRUE),
    Median = median(eGFR, na.rm = TRUE),
    SD = sd(eGFR, na.rm = TRUE),
    Min = min(eGFR, na.rm = TRUE),
    Max = max(eGFR, na.rm = TRUE),
    N = sum(!is.na(eGFR))
  )

# Анализ качественной переменной: Appetite
table(df$Appetite..good.poor.)  # Проверка уровней
table(df$Appetite..good.poor., df$Age_group)  # Кросс-таблица
prop.table(table(df$Appetite..good.poor., df$Age_group), margin = 2)  # Доли по возрастным группам



```

#### **Разведывательный анализ данных**

Количественная переменная: `eGFR`

(Estimated Glomerular Filtration Rate — оценка скорости клубочковой фильтрации)
**Минимум:** 5

**Максимум:** 120

**Среднее:** 62.23

**Медиана:** 62.15

**Стандартное отклонение:** 33.35

**Распределение:**\

Результат теста Шапиро-Уилка на нормальность (на подвыборке из 5000 наблюдений):

-   `W = 0.95132`, **p \< 2.2e-16** — **распределение значительно отклоняется от нормального**.

#### Качественная переменная: `Appetite..good.poor.`

(Аппетит: good / poor)

-   **Распределение:**

    -   good — 10384 пациентов

        poor — 10154 пациентов - переменная сбалансирована (поровну наблюдений)

    **Связь с возрастом (переменная `Age_group`, 4 уровня):**\

    Аппетит примерно одинаково распределён между возрастными группами:

    -   В каждой возрастной категории около **49–51% пациентов** имеют poor appetite.

        Это говорит об **отсутствии выраженной связи аппетита с возрастом**, по крайней мере на уровне пропорций

-   В качестве **количественной переменной** выбрана `eGFR` — ключевой биомаркер функции почек.

    В качестве **качественной переменной (с ≥3 уровнями)** использована `Age_group` (0–24, 25–49, 50–74, 75+).

```{r}
# Гистограмма распределения eGFR
p1 <- ggplot(df, aes(x = eGFR)) +
  geom_histogram(bins = 30, fill = "skyblue", color = "black") +
  labs(title = "Распределение eGFR", x = "eGFR (ml/min/1.73m²)", y = "Частота") +
  theme_minimal()

# Boxplot eGFR по группам аппетита
p2 <- ggplot(df, aes(x = Appetite, y = eGFR, fill = Appetite)) +
  geom_boxplot() +
  labs(title = "Распределение eGFR по группам аппетита", 
       x = "Аппетит", y = "eGFR (ml/min/1.73m²)") +
  theme_minimal()

# Barplot распределения аппетита по возрастным группам
p3 <- ggplot(df, aes(x = Age_group, fill = Appetite)) +
  geom_bar(position = "fill") +
  labs(title = "Распределение аппетита по возрастным группам",
       x = "Возрастная группа", y = "Доля") +
  theme_minimal()

# Q-Q plot для проверки нормальности eGFR
p4 <- ggplot(df, aes(sample = eGFR)) +
  stat_qq() + stat_qq_line() +
  labs(title = "Q-Q plot для eGFR") +
  theme_minimal()

# Объединяем графики
grid.arrange(p1, p2, p3, p4, ncol = 2)
```

```{r}
# Проверка нормальности распределения eGFR в группах
df %>% group_by(Appetite) %>% shapiro_test(eGFR)

res.aov <- aov(eGFR ~ Appetite, data = df)
summary(res.aov)

# Post-hoc тест с поправкой Тьюки
tukey.hsd <- TukeyHSD(res.aov)
tukey.hsd

# Визуализация результатов post-hoc теста
plot(tukey.hsd)

# Выбираем дополнительную качественную переменную: Hypertension
# Сравниваем eGFR между группами Hypertension
t.test(eGFR ~ Hypertension, data = df)

# Визуализация
ggplot(df, aes(x = Hypertension, y = eGFR, fill = Hypertension)) +
  geom_boxplot() +
  stat_compare_means(method = "t.test") +
  labs(title = "Сравнение eGFR между группами с гипертензией",
       x = "Гипертензия", y = "eGFR (ml/min/1.73m²)") +
  theme_minimal()
```

####  **Сравнение eGFR между группами с разным аппетитом (ANOVA)**

-   **Однофакторный дисперсионный анализ (ANOVA)**:

    -   **F-статистика = 1.275**, **p-value = 0.28** → **нет статистически значимых различий** в средних значениях eGFR между группами с разным аппетитом (good, normal, poor).

    -   **Средние значения eGFR**:

        -   **Good**: \~90.05

        -   **Normal**: \~86.81

        -   **Poor**: \~87.63

    -   **Вывод**: Аппетит **не оказывает значимого влияния** на скорость клубочковой фильтрации.

-   **Post-hoc тест (Tukey HSD)**:

    | **Сравнение** | **Разница (diff)** | **95% ДИ (lwr; upr)** | **p-value** |
    |:--------------|:-------------------|:----------------------|:------------|
    | normal - good | -3.24              | [-8.14; 1.67]         | 0.268       |
    | poor - good   | -2.42              | [-7.33; 2.50]         | 0.480       |
    | poor - normal | 0.82               | [-3.88; 5.53]         | 0.912       |

    -   **Ни одна из пар сравнений не значима** (все p \> 0.05).

    -   **Интерпретация**:

        -   Пациенты с **плохим аппетитом** имеют **незначительно ниже eGFR**, чем с хорошим, но разница статистически не подтверждена.

        -   Между **poor и normal** группами разница минимальна (\~0.82 мл/мин/1.73м²).

#### **2. Сравнение eGFR между группами с гипертензией и без (t-тест)**

-   **Двухвыборочный t-тест Уэлча**:

    -   **t = -1.28**, **p-value = 0.201** → **нет значимой разницы** в eGFR между пациентами с гипертензией (yes) и без (no).

    -   **Средние значения**:

        -   **Без гипертензии (no)**: **87.90** мл/мин/1.73м².

        -   **С гипертензией (yes)**: **90.05** мл/мин/1.73м².

    -   **95% доверительный интервал разницы**: **[-5.45; 1.15]**.

        -   Нулевое значение (0) попадает в интервал → разница **не значима**.

    -   **Вывод**:

        -   Гипертензия **не ассоциирована** со снижением eGFR в данной выборке.

        -   Наблюдается **тенденция к более высокому eGFR в группе с гипертензией**, но это может быть случайным колебанием.

### **Общие выводы**

1.  **Ни аппетит, ни гипертензия не показали значимой связи с eGFR** в данной выборке.

2.  **Возможные причины**:

    -   Недостаточный размер выборки для выявления слабых эффектов.

    -   Влияние других факторов (диабет, возраст), которые не учитывались в этих тестах.

```{r}

# Возраст (Age), Артериальное давление (Blood_pressure), Диабет (Diabetes)
model_lm <- lm(eGFR ~ Age + Blood_pressure + Diabetes, data = df)

# Вывод summary модели
summary(model_lm)

# 1. Линейность и гомоскедастичность (график остатков)
plot1 <- ggplot(data.frame(Fitted = fitted(model_lm), 
                          Residuals = resid(model_lm)), 
               aes(x = Fitted, y = Residuals)) +
  geom_point(alpha = 0.6) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  geom_smooth(method = "loess", se = FALSE, color = "blue") +
  labs(title = "Остатки vs. Предсказанные значения",
       x = "Предсказанные значения eGFR", 
       y = "Остатки") +
  theme_minimal()

# 2. Нормальность распределения остатков (Q-Q plot)
plot2 <- ggplot(data.frame(Residuals = resid(model_lm)), 
               aes(sample = Residuals)) +
  stat_qq() + 
  stat_qq_line(color = "red") +
  labs(title = "Q-Q plot остатков",
       x = "Теоретические квантили", 
       y = "Выборочные квантили") +
  theme_minimal()

# 3. Проверка на мультиколлинеарность (VIF)
if (!require(car)) install.packages("car")
library(car)
vif_values <- vif(model_lm)
print(vif_values)

# График VIF
plot3 <- ggplot(data.frame(Variables = names(vif_values), 
                          VIF = vif_values),
               aes(x = Variables, y = VIF)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  geom_hline(yintercept = 5, linetype = "dashed", color = "red") +
  labs(title = "Проверка мультиколлинеарности (VIF)",
       x = "Предикторы", 
       y = "VIF") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Объединяем все графики
if (!require(gridExtra)) install.packages("gridExtra")
library(gridExtra)
grid.arrange(plot1, plot2, plot3, ncol = 2)

# Дополнительная визуализация: парциальные регрессионные графики
if (!require(visreg)) install.packages("visreg")
library(visreg)

# Для непрерывных предикторов
visreg(model_lm, "Age", gg = TRUE) + 
  labs(title = "Частичная зависимость: Возраст",
       y = "eGFR (скорректированный)") +
  theme_minimal()

visreg(model_lm, "Blood_pressure", gg = TRUE) + 
  labs(title = "Частичная зависимость: Артериальное давление",
       y = "eGFR (скорректированный)") +
  theme_minimal()

# Для категориального предиктора
visreg(model_lm, "Diabetes", gg = TRUE) + 
  labs(title = "Частичная зависимость: Диабет",
       y = "eGFR (скорректированный)") +
  theme_minimal()
```

-   **Зависимая переменная**: eGFR (скорость клубочковой фильтрации)

-   **Предикторы**:

    -   `Age` (возраст)

    -   `Blood_pressure` (артериальное давление)

    -   `Diabetes` (наличие диабета, категориальная переменная: yes/no)

-   **Качество модели**:

    -   **R² = 0.0037** (0.37%) – модель объясняет менее 1% вариации eGFR.

    -   **Скорректированный R² = -0.0023** – отрицательное значение указывает, что модель хуже, чем просто использование среднего значения.

    -   **F-статистика = 0.617, p-value = 0.604** → модель **не значима** в целом.

#### **2. Анализ коэффициентов**

| **Предиктор** | **Коэффициент (β)** | **Стандартная ошибка** | **t-значение** | **p-value** | **Интерпретация** |
|:---------|:---------|:---------|:---------|:---------|:------------------------|
| **Intercept** | 92.005 | 7.248 | 12.694 | \<2e-16\*\*\* | Базовый уровень eGFR при нулевых значениях предикторов (не имеет смысла). |
| **Age** | -0.055 | 0.041 | -1.357 | 0.176 | С каждым годом eGFR снижается на **0.055** мл/мин/1.73м² (не значимо, p\>0.05). |
| **Blood_pressure** | 0.0003 | 0.056 | 0.006 | 0.995 | Давление **не влияет** на eGFR (β ≈ 0, p=0.995). |
| **Diabetesyes** | -0.316 | 1.687 | -0.187 | 0.852 | Диабет снижает eGFR на **0.316** мл/мин/1.73м² (не значимо, p\>0.05). |

#### **3. Проверка на мультиколлинеарность (VIF)**

-   **VIF (фактор инфляции дисперсии)**:

    -   Все значения **\<1.01** (гораздо меньше порога 5) - **мультиколлинеарность отсутствует**.

#### **4. Анализ остатков**

-   **Распределение остатков**:

    -   Min: -53.8, Max: 61.3 - есть выбросы.

    -   Медиана близка к 0 (-0.278) - симметричность.

-   **Residual standard error = 18.78** - типичное отклонение предсказаний от реальных значений.

### **Основные выводы**

1.  **Модель не имеет предсказательной силы**:

    -   Ни один из предикторов (возраст, давление, диабет) **не показал значимого влияния** на eGFR.

    -   R² близок к 0 - модель бесполезна для объяснения вариации eGFR.

2.  **Биологическая интерпретация**:

    -   Ожидалось, что:

        -   Возраст и диабет должны снижать eGFR (но коэффициенты незначимы).

        -   Давление может влиять на функцию почек (но эффект отсутствует).

    -   **Возможные причины**:

        -   Неучтенные факторы (например, уровень креатинина, гиперфильтрация при раннем диабете).

        -   Нелинейные зависимости (например, U-образная связь давления и eGFR).

```{r}

df$Anemia <- as.factor(df$Anemia)
levels(df$Anemia) # Проверяем уровни
df$Anemia <- relevel(df$Anemia, ref = "no") # Устанавливаем референсный уровень

# 2. Построение модели
model_glm <- glm(Anemia ~ eGFR + Age + Diabetes,
                data = df,
                family = binomial(link = "logit"))

# 3. Анализ модели
summary(model_glm)

# Одношаговая таблица с OR и CI
cbind(
  OR = exp(coef(model_glm)),
  exp(confint(model_glm))
) %>% round(3) %>% as.data.frame()

# 4. Проверка допущений
# Создаем бины для непрерывных переменных
df_binned <- df %>%
  mutate(
    eGFR_bin = cut(eGFR, breaks = quantile(eGFR, probs = seq(0, 1, 0.2), na.rm = TRUE),
                   include.lowest = TRUE),
    Age_bin = cut(Age, breaks = quantile(Age, probs = seq(0, 1, 0.2), na.rm = TRUE),
                   include.lowest = TRUE)
  )

# Вычисляем логарифм шансов для eGFR
logit_eGFR <- df_binned %>%
  group_by(eGFR_bin) %>%
  summarise(
    mean_anemia = mean(Anemia == "yes", na.rm = TRUE),
    log_odds = log((mean_anemia + 0.0001) / (1 - mean_anemia + 0.0001)))

# График проверки линейности
plot_linearity <- ggplot(logit_eGFR, aes(x = as.numeric(eGFR_bin), y = log_odds)) +
  geom_point(size = 3, color = "darkred") +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +
  labs(title = "Проверка линейности: eGFR",
       x = "Группы eGFR", 
       y = "Логарифм шансов анемии") +
  theme_minimal()

# 5. Оценка качества модели
# ROC-анализ
library(pROC)
roc_obj <- roc(response = as.numeric(df$Anemia) - 1,
              predictor = predict(model_glm, type = "response"))
plot(roc_obj, print.auc = TRUE)

# 6. График предсказанных вероятностей
df$pred_prob <- predict(model_glm, type = "response")
plot_prob <- ggplot(df, aes(x = eGFR, y = pred_prob, color = Diabetes)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "loess") +
  labs(title = "Вероятность анемии по eGFR и диабету",
       x = "eGFR", 
       y = "Предсказанная вероятность",
       color = "Диабет") +
  theme_minimal()

# Вывод всех графиков
library(gridExtra)
grid.arrange(plot_linearity, plot_prob, ncol = 2)
```

#### **1. Общая информация о модели**

-   **Зависимая переменная**: Наличие анемии (`Anemia`: бинарная, "no"/"yes").
-   **Предикторы**:
    -   `eGFR` (скорость клубочковой фильтрации).
    -   `Age` (возраст).
    -   `Diabetes` (наличие диабета: "yes"/"no").
-   **Семейство модели**: Биномиальное с логит-связью.

#### **2. Анализ коэффициентов (логарифмы шансов)**

| Предиктор | Коэффициент (β) | Стандартная ошибка | z-значение | p-value | **OR (exp(β))** | Интерпретация |
|---------|---------|---------|---------|---------|---------|----------------------|
| **(Intercept)** | -1.199 | 0.525 | -2.283 | 0.022\* | 0.30 | Базовый уровень шансов анемии при нулевых предикторах (условный параметр). |
| **eGFR** | 0.008 | 0.005 | 1.711 | 0.087. | 1.01 | Каждое увеличение eGFR на 1 мл/мин/1.73м² повышает шансы анемии на **1%** (тенденция к значимости, p=0.087). |
| **Age** | 0.007 | 0.004 | 1.495 | 0.135 | 1.01 | С каждым годом шансы анемии растут на **1%** (не значимо, p\>0.05). |
| **Diabetesyes** | 0.010 | 0.180 | 0.056 | 0.956 | 1.01 | Диабет **не влияет** на анемию (OR≈1, p=0.956). |

#### **3. Качество модели**

-   **Null deviance (нулевая модель)**: 691.79.
-   **Residual deviance (текущая модель)**: 686.90.
    -   Уменьшение девианса незначительное - модель **слабо улучшает** предсказание по сравнению с нулевой.
-   **AIC = 694.9** - для сравнения с альтернативными моделями (меньше = лучше).
-   **Вывод**: Модель **не объясняет** значимую долю вариации анемии.

#### **4. Проверка значимости предикторов**

-   **Единственный значимый параметр**: Константа (p=0.022), но она не имеет содержательной интерпретации.
-   **eGFR**: Пограничная значимость (p=0.087) - требует дополнительного исследования.
-   **Age и Diabetes**: Не значимы (p\>0.1).

### **Основные выводы**

1.  **eGFR**:
    -   Неожиданный **положительный** эффект на анемию (OR=1.01, p=0.087).
    -   Ожидалось, что снижение eGFR (ухудшение функции почек) связано с анемией, но результат **противоположный**.
    -   **Возможные причины**:
        -   Ошибка в данных (например, пациенты с высоким eGFR получали нефротоксичные препараты).
        -   Неучтенные смешивающие факторы (например, воспаление).
2.  **Диабет**:
    -   Нет значимой связи с анемией (p=0.956), что противоречит некоторым клиническим данным.
    -   Возможно, нужна стратификация по типу диабета или длительности заболевания.
3.  **Возраст**:
    -   Ожидалось, что пожилые пациенты чаще страдают анемией, но эффект **не значим** (p=0.135).
