```{r}
# Скрипт для установки всех необходимых пакетов

# Список необходимых пакетов
required_packages <- c(
  "tidyverse",    # Для обработки и визуализации данных
  "ggplot2",      # Для создания графиков (входит в tidyverse, но указан отдельно для ясности)
  "car",          # Для теста на мультиколлинеарность (vif) и других диагностик
  "nortest",      # Для теста Anderson-Darling на нормальность
  "ggpubr",       # Для оформления графиков и добавления p-значений
  "rstatix",      # Для непараметрических тестов и пост-хок анализа
  "broom",        # Для обработки результатов статистических тестов
  "caret",        # Для анализа моделей машинного обучения
  "pROC",         # Для построения ROC-кривых
  "MASS"          # Для дополнительных статистических функций
)

# Функция для проверки и установки пакетов
install_if_needed <- function(packages) {
  for (pkg in packages) {
    if (!requireNamespace(pkg, quietly = TRUE)) {
      install.packages(pkg, dependencies = TRUE)
      message(paste("Пакет", pkg, "установлен"))
    } else {
      message(paste("Пакет", pkg, "уже установлен"))
    }
  }
}

# Установка всех необходимых пакетов
install_if_needed(required_packages)

# Проверка успешной установки и загрузки
message("\nПроверка загрузки пакетов:")
for (pkg in required_packages) {
  if (requireNamespace(pkg, quietly = TRUE)) {
    message(paste("Пакет", pkg, "успешно загружен"))
  } else {
    warning(paste("Не удалось загрузить пакет", pkg))
  }
}

message("\nВсе необходимые пакеты установлены и проверены!")
```

```{r}

```

```{r}
# Очистите кеш (на всякий случай)
remove.packages("tidyverse")

# Попробуйте установить с явным указанием репозитория
install.packages("tidyverse", repos = "https://cloud.r-project.org")

# Проверьте вывод на ошибки (должно быть "package ‘tidyverse’ successfully unpacked")
```

```{r}
# Загрузка необходимых библиотек
library(tidyverse)
library(ggplot2)
library(car)
library(ggpubr)
library(rstatix)
library(broom)
library(corrplot)
library(gridExtra)

# Предположим, что данные уже загружены в переменную df
df <- read.csv("kidney_disease_dataset.csv")

# Для примера создадим синтетические данные
set.seed(123)
n <- 500
df <- data.frame(
  Age = sample(18:90, n, replace = TRUE),
  Blood_pressure = rnorm(n, 120, 15),
  Specific_gravity = runif(n, 1.005, 1.030),
  Albumin = sample(c("normal", "abnormal"), n, replace = TRUE),
  Sugar = sample(c("normal", "abnormal"), n, replace = TRUE),
  Appetite = sample(c("good", "poor", "normal"), n, replace = TRUE),
  eGFR = rnorm(n, 90, 20),
  Hypertension = sample(c("yes", "no"), n, replace = TRUE),
  Diabetes = sample(c("yes", "no"), n, replace = TRUE),
  Anemia = sample(c("yes", "no"), n, replace = TRUE)
)

# Выбираем количественную переменную: eGFR (Estimated Glomerular Filtration Rate)
# Выбираем качественную переменную с тремя уровнями: Appetite (good, poor, normal)

# Анализ количественной переменной
summary(df$eGFR)
sd(df$eGFR)
shapiro.test(df$eGFR) # Тест на нормальность

# Разделяем возраст на группы
df$Age_group <- cut(df$Age, 
                   breaks = c(0, 24, 49, 74, Inf),
                   labels = c("0-24", "25-49", "50-74", "75+"))

# Описательная статистика для eGFR по возрастным группам
df %>%
  group_by(Age_group) %>%
  summarise(
    Mean = mean(eGFR),
    Median = median(eGFR),
    SD = sd(eGFR),
    Min = min(eGFR),
    Max = max(eGFR),
    N = n()
  )

# Описательная статистика для Appetite по возрастным группам
table(df$Appetite, df$Age_group)
prop.table(table(df$Appetite, df$Age_group), margin = 2)
```

#### **1. Анализ количественной переменной (eGFR — скорость клубочковой фильтрации)**

-   **Описательная статистика**:
    -   **Минимальное значение (Min)**: **33.03** мл/мин/1.73м² — у пациента сильно сниженная функция почек (возможна ХБП 3-4 стадии).
    -   **1-й квартиль (1st Qu)**: **76.77** — у 25% пациентов eGFR ниже этого значения (норма или легкое снижение).
    -   **Медиана (Median)**: **88.69** — типичное значение eGFR в выборке соответствует **нормальной функции почек** (норма: ≥90 мл/мин/1.73м²).
    -   **Среднее (Mean)**: **88.90** — близко к медиане, что указывает на **отсутствие сильного перекоса** в данных.
    -   **3-й квартиль (3rd Qu)**: **101.55** — у 75% пациентов eGFR ниже этого уровня (норма или повышенная фильтрация).
    -   **Максимальное значение (Max)**: **150.44** — гиперфильтрация (может встречаться при диабете, беременности).
    -   **Стандартное отклонение (SD)**: **18.76** — умеренный разброс значений вокруг среднего.
-   **Тест Шапиро-Уилка на нормальность**:
    -   **W = 0.998, p-value = 0.8988** → **данные распределены нормально** (p \> 0.05).
    -   **Вывод**: Для описания eGFR можно использовать **среднее и стандартное отклонение**.

#### **2. Анализ качественной переменной (Appetite — аппетит) по возрастным группам**

-   **Абсолютные частоты**:
    -   **0-24 года**:
        -   Хороший аппетит — **12** пациентов.
        -   Нормальный — **20**.
        -   Плохой — **15**.
    -   **25-49 лет**:
        -   Хороший — **53**, нормальный — **56**, плохой — **57**.
    -   **50-74 года**:
        -   Хороший — **48**, нормальный — **63**, плохой — **71** (наибольшее число пациентов с **плохим аппетитом**).
    -   **75+ лет**:
        -   Хороший — **36**, нормальный — **37**, плохой — **32**.
-   **Относительные частоты (доли в %)**:
    -   **0-24 года**:
        -   **25.5%** — хороший аппетит, **42.6%** — нормальный, **31.9%** — плохой.
    -   **25-49 лет**:
        -   **31.9%** — хороший, **33.7%** — нормальный, **34.3%** — плохой.
    -   **50-74 года**:
        -   **26.4%** — хороший, **34.6%** — нормальный, **39%** — плохой (**наибольшая доля**).
    -   **75+ лет**:
        -   **34.3%** — хороший, **35.2%** — нормальный, **30.5%** — плохой.

**Основные выводы**:\
1. **С возрастом снижается доля пациентов с хорошим аппетитом** (минимум в группе 50-74 года).\
2. **Плохой аппетит чаще встречается в группе 50-74 года** (39%), что может быть связано с хроническими заболеваниями.\
3. **В самой старшей группе (75+) аппетит несколько улучшается** по сравнению с предыдущей возрастной категорией.

------------------------------------------------------------------------

### **Итог по заданию 1**:

-   **eGFR** имеет **нормальное распределение** со средним \~89 мл/мин/1.73м².
-   **Аппетит** значимо **меняется с возрастом**:
    -   Наихудшие показатели — в группе **50-74 года**.
    -   Возможные причины: прогрессирование ХБП, диабета, сердечной недостаточности.

```{r}
# Гистограмма распределения eGFR
p1 <- ggplot(df, aes(x = eGFR)) +
  geom_histogram(bins = 30, fill = "skyblue", color = "black") +
  labs(title = "Распределение eGFR", x = "eGFR (ml/min/1.73m²)", y = "Частота") +
  theme_minimal()

# Boxplot eGFR по группам аппетита
p2 <- ggplot(df, aes(x = Appetite, y = eGFR, fill = Appetite)) +
  geom_boxplot() +
  labs(title = "Распределение eGFR по группам аппетита", 
       x = "Аппетит", y = "eGFR (ml/min/1.73m²)") +
  theme_minimal()

# Barplot распределения аппетита по возрастным группам
p3 <- ggplot(df, aes(x = Age_group, fill = Appetite)) +
  geom_bar(position = "fill") +
  labs(title = "Распределение аппетита по возрастным группам",
       x = "Возрастная группа", y = "Доля") +
  theme_minimal()

# Q-Q plot для проверки нормальности eGFR
p4 <- ggplot(df, aes(sample = eGFR)) +
  stat_qq() + stat_qq_line() +
  labs(title = "Q-Q plot для eGFR") +
  theme_minimal()

# Объединяем графики
grid.arrange(p1, p2, p3, p4, ncol = 2)
```

```{r}
# Проверка нормальности распределения eGFR в группах
df %>% group_by(Appetite) %>% shapiro_test(eGFR)

# Поскольку распределение близко к нормальному, используем ANOVA
res.aov <- aov(eGFR ~ Appetite, data = df)
summary(res.aov)

# Post-hoc тест с поправкой Тьюки
tukey.hsd <- TukeyHSD(res.aov)
tukey.hsd

# Визуализация результатов post-hoc теста
plot(tukey.hsd)

# Выбираем дополнительную качественную переменную: Hypertension
# Сравниваем eGFR между группами Hypertension
t.test(eGFR ~ Hypertension, data = df)

# Визуализация
ggplot(df, aes(x = Hypertension, y = eGFR, fill = Hypertension)) +
  geom_boxplot() +
  stat_compare_means(method = "t.test") +
  labs(title = "Сравнение eGFR между группами с гипертензией",
       x = "Гипертензия", y = "eGFR (ml/min/1.73m²)") +
  theme_minimal()
```

####  **Сравнение eGFR между группами с разным аппетитом (ANOVA)**

-   **Однофакторный дисперсионный анализ (ANOVA)**:

    -   **F-статистика = 1.275**, **p-value = 0.28** → **нет статистически значимых различий** в средних значениях eGFR между группами с разным аппетитом (good, normal, poor).

    -   **Средние значения eGFR**:

        -   **Good**: \~90.05

        -   **Normal**: \~86.81

        -   **Poor**: \~87.63

    -   **Вывод**: Аппетит **не оказывает значимого влияния** на скорость клубочковой фильтрации.

-   **Post-hoc тест (Tukey HSD)**:

    | **Сравнение** | **Разница (diff)** | **95% ДИ (lwr; upr)** | **p-value** |
    |:--------------|:-------------------|:----------------------|:------------|
    | normal - good | -3.24              | [-8.14; 1.67]         | 0.268       |
    | poor - good   | -2.42              | [-7.33; 2.50]         | 0.480       |
    | poor - normal | 0.82               | [-3.88; 5.53]         | 0.912       |

    -   **Ни одна из пар сравнений не значима** (все p \> 0.05).

    -   **Интерпретация**:

        -   Пациенты с **плохим аппетитом** имеют **незначительно ниже eGFR**, чем с хорошим, но разница статистически не подтверждена.

        -   Между **poor и normal** группами разница минимальна (\~0.82 мл/мин/1.73м²).

#### **2. Сравнение eGFR между группами с гипертензией и без (t-тест)**

-   **Двухвыборочный t-тест Уэлча**:

    -   **t = -1.28**, **p-value = 0.201** → **нет значимой разницы** в eGFR между пациентами с гипертензией (yes) и без (no).

    -   **Средние значения**:

        -   **Без гипертензии (no)**: **87.90** мл/мин/1.73м².

        -   **С гипертензией (yes)**: **90.05** мл/мин/1.73м².

    -   **95% доверительный интервал разницы**: **[-5.45; 1.15]**.

        -   Нулевое значение (0) попадает в интервал → разница **не значима**.

    -   **Вывод**:

        -   Гипертензия **не ассоциирована** со снижением eGFR в данной выборке.

        -   Наблюдается **тенденция к более высокому eGFR в группе с гипертензией**, но это может быть случайным колебанием.

### **Общие выводы**

1.  **Ни аппетит, ни гипертензия не показали значимой связи с eGFR** в данной выборке.

2.  **Возможные причины**:

    -   Недостаточный размер выборки для выявления слабых эффектов.

    -   Влияние других факторов (диабет, возраст), которые не учитывались в этих тестах.

```{r}
# Задание 4. Линейная регрессия для eGFR

# Построим модель с биологически обоснованными предикторами:
# Возраст (Age), Артериальное давление (Blood_pressure), Диабет (Diabetes)
model_lm <- lm(eGFR ~ Age + Blood_pressure + Diabetes, data = df)

# Вывод summary модели
summary(model_lm)

### Проверка допущений линейной регрессии ###

# 1. Линейность и гомоскедастичность (график остатков)
plot1 <- ggplot(data.frame(Fitted = fitted(model_lm), 
                          Residuals = resid(model_lm)), 
               aes(x = Fitted, y = Residuals)) +
  geom_point(alpha = 0.6) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  geom_smooth(method = "loess", se = FALSE, color = "blue") +
  labs(title = "Остатки vs. Предсказанные значения",
       x = "Предсказанные значения eGFR", 
       y = "Остатки") +
  theme_minimal()

# 2. Нормальность распределения остатков (Q-Q plot)
plot2 <- ggplot(data.frame(Residuals = resid(model_lm)), 
               aes(sample = Residuals)) +
  stat_qq() + 
  stat_qq_line(color = "red") +
  labs(title = "Q-Q plot остатков",
       x = "Теоретические квантили", 
       y = "Выборочные квантили") +
  theme_minimal()

# 3. Проверка на мультиколлинеарность (VIF)
if (!require(car)) install.packages("car")
library(car)
vif_values <- vif(model_lm)
print(vif_values)

# График VIF
plot3 <- ggplot(data.frame(Variables = names(vif_values), 
                          VIF = vif_values),
               aes(x = Variables, y = VIF)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  geom_hline(yintercept = 5, linetype = "dashed", color = "red") +
  labs(title = "Проверка мультиколлинеарности (VIF)",
       x = "Предикторы", 
       y = "VIF") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Объединяем все графики
if (!require(gridExtra)) install.packages("gridExtra")
library(gridExtra)
grid.arrange(plot1, plot2, plot3, ncol = 2)

# Дополнительная визуализация: парциальные регрессионные графики
if (!require(visreg)) install.packages("visreg")
library(visreg)

# Для непрерывных предикторов
visreg(model_lm, "Age", gg = TRUE) + 
  labs(title = "Частичная зависимость: Возраст",
       y = "eGFR (скорректированный)") +
  theme_minimal()

visreg(model_lm, "Blood_pressure", gg = TRUE) + 
  labs(title = "Частичная зависимость: Артериальное давление",
       y = "eGFR (скорректированный)") +
  theme_minimal()

# Для категориального предиктора
visreg(model_lm, "Diabetes", gg = TRUE) + 
  labs(title = "Частичная зависимость: Диабет",
       y = "eGFR (скорректированный)") +
  theme_minimal()
```

-   **Зависимая переменная**: eGFR (скорость клубочковой фильтрации)

-   **Предикторы**:

    -   `Age` (возраст)

    -   `Blood_pressure` (артериальное давление)

    -   `Diabetes` (наличие диабета, категориальная переменная: yes/no)

-   **Качество модели**:

    -   **R² = 0.0037** (0.37%) – модель объясняет менее 1% вариации eGFR.

    -   **Скорректированный R² = -0.0023** – отрицательное значение указывает, что модель хуже, чем просто использование среднего значения.

    -   **F-статистика = 0.617, p-value = 0.604** → модель **не значима** в целом.

#### **2. Анализ коэффициентов**

| **Предиктор** | **Коэффициент (β)** | **Стандартная ошибка** | **t-значение** | **p-value** | **Интерпретация** |
|:---------|:---------|:---------|:---------|:---------|:------------------------|
| **Intercept** | 92.005 | 7.248 | 12.694 | \<2e-16\*\*\* | Базовый уровень eGFR при нулевых значениях предикторов (не имеет смысла). |
| **Age** | -0.055 | 0.041 | -1.357 | 0.176 | С каждым годом eGFR снижается на **0.055** мл/мин/1.73м² (не значимо, p\>0.05). |
| **Blood_pressure** | 0.0003 | 0.056 | 0.006 | 0.995 | Давление **не влияет** на eGFR (β ≈ 0, p=0.995). |
| **Diabetesyes** | -0.316 | 1.687 | -0.187 | 0.852 | Диабет снижает eGFR на **0.316** мл/мин/1.73м² (не значимо, p\>0.05). |

#### **3. Проверка на мультиколлинеарность (VIF)**

-   **VIF (фактор инфляции дисперсии)**:

    -   Все значения **\<1.01** (гораздо меньше порога 5) → **мультиколлинеарность отсутствует**.

#### **4. Анализ остатков**

-   **Распределение остатков**:

    -   Min: -53.8, Max: 61.3 → есть выбросы.

    -   Медиана близка к 0 (-0.278) → симметричность.

-   **Residual standard error = 18.78** → типичное отклонение предсказаний от реальных значений.

### **Основные выводы**

1.  **Модель не имеет предсказательной силы**:

    -   Ни один из предикторов (возраст, давление, диабет) **не показал значимого влияния** на eGFR.

    -   R² близок к 0 → модель бесполезна для объяснения вариации eGFR.

2.  **Биологическая интерпретация**:

    -   Ожидалось, что:

        -   Возраст и диабет должны снижать eGFR (но коэффициенты незначимы).

        -   Давление может влиять на функцию почек (но эффект отсутствует).

    -   **Возможные причины**:

        -   Неучтенные факторы (например, уровень креатинина, гиперфильтрация при раннем диабете).

        -   Нелинейные зависимости (например, U-образная связь давления и eGFR).

```{r}
# Задание 5. Логистическая регрессия (полная версия)

# 1. Подготовка данных
# Преобразуем целевую переменную
df$Anemia <- as.factor(df$Anemia)
levels(df$Anemia) # Проверяем уровни
df$Anemia <- relevel(df$Anemia, ref = "no") # Устанавливаем референсный уровень

# 2. Построение модели
model_glm <- glm(Anemia ~ eGFR + Age + Diabetes,
                data = df,
                family = binomial(link = "logit"))

# 3. Анализ модели
summary(model_glm)

# Одношаговая таблица с OR и CI
cbind(
  OR = exp(coef(model_glm)),
  exp(confint(model_glm))
) %>% round(3) %>% as.data.frame()

# 4. Проверка допущений
# Создаем бины для непрерывных переменных
df_binned <- df %>%
  mutate(
    eGFR_bin = cut(eGFR, breaks = quantile(eGFR, probs = seq(0, 1, 0.2), na.rm = TRUE),
                   include.lowest = TRUE),
    Age_bin = cut(Age, breaks = quantile(Age, probs = seq(0, 1, 0.2), na.rm = TRUE),
                   include.lowest = TRUE)
  )

# Вычисляем логарифм шансов для eGFR
logit_eGFR <- df_binned %>%
  group_by(eGFR_bin) %>%
  summarise(
    mean_anemia = mean(Anemia == "yes", na.rm = TRUE),
    log_odds = log((mean_anemia + 0.0001) / (1 - mean_anemia + 0.0001)))

# График проверки линейности
plot_linearity <- ggplot(logit_eGFR, aes(x = as.numeric(eGFR_bin), y = log_odds)) +
  geom_point(size = 3, color = "darkred") +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +
  labs(title = "Проверка линейности: eGFR",
       x = "Группы eGFR", 
       y = "Логарифм шансов анемии") +
  theme_minimal()

# 5. Оценка качества модели
# ROC-анализ
library(pROC)
roc_obj <- roc(response = as.numeric(df$Anemia) - 1,
              predictor = predict(model_glm, type = "response"))
plot(roc_obj, print.auc = TRUE)

# 6. График предсказанных вероятностей
df$pred_prob <- predict(model_glm, type = "response")
plot_prob <- ggplot(df, aes(x = eGFR, y = pred_prob, color = Diabetes)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "loess") +
  labs(title = "Вероятность анемии по eGFR и диабету",
       x = "eGFR", 
       y = "Предсказанная вероятность",
       color = "Диабет") +
  theme_minimal()

# Вывод всех графиков
library(gridExtra)
grid.arrange(plot_linearity, plot_prob, ncol = 2)
```

#### **1. Общая информация о модели**

-   **Зависимая переменная**: Наличие анемии (`Anemia`: бинарная, "no"/"yes").
-   **Предикторы**:
    -   `eGFR` (скорость клубочковой фильтрации).
    -   `Age` (возраст).
    -   `Diabetes` (наличие диабета: "yes"/"no").
-   **Семейство модели**: Биномиальное с логит-связью.

#### **2. Анализ коэффициентов (логарифмы шансов)**

| Предиктор | Коэффициент (β) | Стандартная ошибка | z-значение | p-value | **OR (exp(β))** | Интерпретация |
|---------|---------|---------|---------|---------|---------|----------------------|
| **(Intercept)** | -1.199 | 0.525 | -2.283 | 0.022\* | 0.30 | Базовый уровень шансов анемии при нулевых предикторах (условный параметр). |
| **eGFR** | 0.008 | 0.005 | 1.711 | 0.087. | 1.01 | Каждое увеличение eGFR на 1 мл/мин/1.73м² повышает шансы анемии на **1%** (тенденция к значимости, p=0.087). |
| **Age** | 0.007 | 0.004 | 1.495 | 0.135 | 1.01 | С каждым годом шансы анемии растут на **1%** (не значимо, p\>0.05). |
| **Diabetesyes** | 0.010 | 0.180 | 0.056 | 0.956 | 1.01 | Диабет **не влияет** на анемию (OR≈1, p=0.956). |

#### **3. Качество модели**

-   **Null deviance (нулевая модель)**: 691.79.
-   **Residual deviance (текущая модель)**: 686.90.
    -   Уменьшение девианса незначительное → модель **слабо улучшает** предсказание по сравнению с нулевой.
-   **AIC = 694.9** → для сравнения с альтернативными моделями (меньше = лучше).
-   **Вывод**: Модель **не объясняет** значимую долю вариации анемии.

#### **4. Проверка значимости предикторов**

-   **Единственный значимый параметр**: Константа (p=0.022), но она не имеет содержательной интерпретации.
-   **eGFR**: Пограничная значимость (p=0.087) → требует дополнительного исследования.
-   **Age и Diabetes**: Не значимы (p\>0.1).

### **Основные выводы**

1.  **eGFR**:
    -   Неожиданный **положительный** эффект на анемию (OR=1.01, p=0.087).
    -   Ожидалось, что снижение eGFR (ухудшение функции почек) связано с анемией, но результат **противоположный**.
    -   **Возможные причины**:
        -   Ошибка в данных (например, пациенты с высоким eGFR получали нефротоксичные препараты).
        -   Неучтенные смешивающие факторы (например, воспаление).
2.  **Диабет**:
    -   Нет значимой связи с анемией (p=0.956), что противоречит некоторым клиническим данным.
    -   Возможно, нужна стратификация по типу диабета или длительности заболевания.
3.  **Возраст**:
    -   Ожидалось, что пожилые пациенты чаще страдают анемией, но эффект **не значим** (p=0.135).
